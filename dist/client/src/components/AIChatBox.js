import { jsx as _jsx, jsxs as _jsxs } from "same-runtime/dist/jsx-runtime";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { ScrollArea } from "@/components/ui/scroll-area";
import { cn } from "@/lib/utils";
import { Loader2, Send, User, Sparkles } from "lucide-react";
import { useState, useEffect, useRef } from "react";
import { Streamdown } from "streamdown";
/**
 * A ready-to-use AI chat box component that integrates with the LLM system.
 *
 * Features:
 * - Matches server-side Message interface for seamless integration
 * - Markdown rendering with Streamdown
 * - Auto-scrolls to latest message
 * - Loading states
 * - Uses global theme colors from index.css
 *
 * @example
 * ```tsx
 * const ChatPage = () => {
 *   const [messages, setMessages] = useState<Message[]>([
 *     { role: "system", content: "You are a helpful assistant." }
 *   ]);
 *
 *   const chatMutation = trpc.ai.chat.useMutation({
 *     onSuccess: (response) => {
 *       // Assuming your tRPC endpoint returns the AI response as a string
 *       setMessages(prev => [...prev, {
 *         role: "assistant",
 *         content: response
 *       }]);
 *     },
 *     onError: (error) => {
 *       console.error("Chat error:", error);
 *       // Optionally show error message to user
 *     }
 *   });
 *
 *   const handleSend = (content: string) => {
 *     const newMessages = [...messages, { role: "user", content }];
 *     setMessages(newMessages);
 *     chatMutation.mutate({ messages: newMessages });
 *   };
 *
 *   return (
 *     <AIChatBox
 *       messages={messages}
 *       onSendMessage={handleSend}
 *       isLoading={chatMutation.isPending}
 *       suggestedPrompts={[
 *         "Explain quantum computing",
 *         "Write a hello world in Python"
 *       ]}
 *     />
 *   );
 * };
 * ```
 */
export function AIChatBox({ messages, onSendMessage, isLoading = false, placeholder = "Type your message...", className, height = "600px", emptyStateMessage = "Start a conversation with AI", suggestedPrompts, }) {
    const [input, setInput] = useState("");
    const scrollAreaRef = useRef(null);
    const containerRef = useRef(null);
    const inputAreaRef = useRef(null);
    const textareaRef = useRef(null);
    // Filter out system messages
    const displayMessages = messages.filter((msg) => msg.role !== "system");
    // Calculate min-height for last assistant message to push user message to top
    const [minHeightForLastMessage, setMinHeightForLastMessage] = useState(0);
    useEffect(() => {
        if (containerRef.current && inputAreaRef.current) {
            const containerHeight = containerRef.current.offsetHeight;
            const inputHeight = inputAreaRef.current.offsetHeight;
            const scrollAreaHeight = containerHeight - inputHeight;
            // Reserve space for:
            // - padding (p-4 = 32px top+bottom)
            // - user message: 40px (item height) + 16px (margin-top from space-y-4) = 56px
            // Note: margin-bottom is not counted because it naturally pushes the assistant message down
            const userMessageReservedHeight = 56;
            const calculatedHeight = scrollAreaHeight - 32 - userMessageReservedHeight;
            setMinHeightForLastMessage(Math.max(0, calculatedHeight));
        }
    }, []);
    // Scroll to bottom helper function with smooth animation
    const scrollToBottom = () => {
        const viewport = scrollAreaRef.current?.querySelector('[data-radix-scroll-area-viewport]');
        if (viewport) {
            requestAnimationFrame(() => {
                viewport.scrollTo({
                    top: viewport.scrollHeight,
                    behavior: 'smooth'
                });
            });
        }
    };
    const handleSubmit = (e) => {
        e.preventDefault();
        const trimmedInput = input.trim();
        if (!trimmedInput || isLoading)
            return;
        onSendMessage(trimmedInput);
        setInput("");
        // Scroll immediately after sending
        scrollToBottom();
        // Keep focus on input
        textareaRef.current?.focus();
    };
    const handleKeyDown = (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            handleSubmit(e);
        }
    };
    return (_jsxs("div", { ref: containerRef, className: cn("flex flex-col bg-card text-card-foreground rounded-lg border shadow-sm", className), style: { height }, children: [_jsx("div", { ref: scrollAreaRef, className: "flex-1 overflow-hidden", children: displayMessages.length === 0 ? (_jsx("div", { className: "flex h-full flex-col p-4", children: _jsxs("div", { className: "flex flex-1 flex-col items-center justify-center gap-6 text-muted-foreground", children: [_jsxs("div", { className: "flex flex-col items-center gap-3", children: [_jsx(Sparkles, { className: "size-12 opacity-20" }), _jsx("p", { className: "text-sm", children: emptyStateMessage })] }), suggestedPrompts && suggestedPrompts.length > 0 && (_jsx("div", { className: "flex max-w-2xl flex-wrap justify-center gap-2", children: suggestedPrompts.map((prompt, index) => (_jsx("button", { onClick: () => onSendMessage(prompt), disabled: isLoading, className: "rounded-lg border border-border bg-card px-4 py-2 text-sm transition-colors hover:bg-accent disabled:cursor-not-allowed disabled:opacity-50", children: prompt }, index))) }))] }) })) : (_jsx(ScrollArea, { className: "h-full", children: _jsxs("div", { className: "flex flex-col space-y-4 p-4", children: [displayMessages.map((message, index) => {
                                // Apply min-height to last message only if NOT loading (when loading, the loading indicator gets it)
                                const isLastMessage = index === displayMessages.length - 1;
                                const shouldApplyMinHeight = isLastMessage && !isLoading && minHeightForLastMessage > 0;
                                return (_jsxs("div", { className: cn("flex gap-3", message.role === "user"
                                        ? "justify-end items-start"
                                        : "justify-start items-start"), style: shouldApplyMinHeight
                                        ? { minHeight: `${minHeightForLastMessage}px` }
                                        : undefined, children: [message.role === "assistant" && (_jsx("div", { className: "size-8 shrink-0 mt-1 rounded-full bg-primary/10 flex items-center justify-center", children: _jsx(Sparkles, { className: "size-4 text-primary" }) })), _jsx("div", { className: cn("max-w-[80%] rounded-lg px-4 py-2.5", message.role === "user"
                                                ? "bg-primary text-primary-foreground"
                                                : "bg-muted text-foreground"), children: message.role === "assistant" ? (_jsx("div", { className: "prose prose-sm dark:prose-invert max-w-none", children: _jsx(Streamdown, { children: message.content }) })) : (_jsx("p", { className: "whitespace-pre-wrap text-sm", children: message.content })) }), message.role === "user" && (_jsx("div", { className: "size-8 shrink-0 mt-1 rounded-full bg-secondary flex items-center justify-center", children: _jsx(User, { className: "size-4 text-secondary-foreground" }) }))] }, index));
                            }), isLoading && (_jsxs("div", { className: "flex items-start gap-3", style: minHeightForLastMessage > 0
                                    ? { minHeight: `${minHeightForLastMessage}px` }
                                    : undefined, children: [_jsx("div", { className: "size-8 shrink-0 mt-1 rounded-full bg-primary/10 flex items-center justify-center", children: _jsx(Sparkles, { className: "size-4 text-primary" }) }), _jsx("div", { className: "rounded-lg bg-muted px-4 py-2.5", children: _jsx(Loader2, { className: "size-4 animate-spin text-muted-foreground" }) })] }))] }) })) }), _jsxs("form", { ref: inputAreaRef, onSubmit: handleSubmit, className: "flex gap-2 p-4 border-t bg-background/50 items-end", children: [_jsx(Textarea, { ref: textareaRef, value: input, onChange: (e) => setInput(e.target.value), onKeyDown: handleKeyDown, placeholder: placeholder, className: "flex-1 max-h-32 resize-none min-h-9", rows: 1 }), _jsx(Button, { type: "submit", size: "icon", disabled: !input.trim() || isLoading, className: "shrink-0 h-[38px] w-[38px]", children: isLoading ? (_jsx(Loader2, { className: "size-4 animate-spin" })) : (_jsx(Send, { className: "size-4" })) })] })] }));
}
